//
// Licensed to the Apache Software Foundation (ASF) under one or more
// contributor license agreements.  See the NOTICE file distributed with
// this work for additional information regarding copyright ownership.
// The ASF licenses this file to You under the Apache License, Version 2.0
// (the "License"); you may not use this file except in compliance with
// the License.  You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
= Apache NiFi Walkthroughs
Apache NiFi Team <dev@nifi.apache.org>
:homepage: http://nifi.apache.org
:linkattrs:

== Installing Apache NiFi
NOTE: The following instructions are for installing NiFi on a single node on a MacBook Pro.

. Go to the link:http://nifi.apache.org/download.html[Apache NiFi Downloads] page.
. Click the link for the following compressed files:
* `nifi-1.11.1-bin.tar.gz` [1.2 GB] ( asc, sha256, sha512 )
* `nifi-toolkit-1.11.1-bin.tar.gz` [42 MB] ( asc, sha256, sha512 )
. Click the first link on each page to download the respective tar file.
+
image::install-download-link.png["Download site"]
. Note that the `nifi-1.11.1-bin.tar.gz` and the `nifi-toolkit-1.11.1-bin.tar.gz` compressed files are downloaded to your `Downloads` folder.
. Extract the files from each `tar.gz` file. The extracted files are saved in the following folders:
* `nifi-<version>`
* `nifi-toolkit-<version>`
. Optionally, move the folders to a more appropriate location.


== Create and Secure a NiFi Cluster with the TLS Toolkit
Complete the following steps to secure your NiFi cluster:
[%hardbreaks]
Step 1. Create the NiFi client certificates using the TLS Toolkit.
Step 2. Update the `nifi.properties` file.
Step 3. Update the `zookeeper.properties` file.
Step 4. Create the `myid` file.
Step 5. Update the `state-management.xml` file.
Step 6. Update the `authorizers.xml` file.
Step 7. Delete the `authorizations.xml` and `users.xml` files.
Step 8. Restart the NiFi cluster.

=== Step 1. Create the NiFi Client Certificates
. Navigate to the `nifi-toolkit-1.11.1/bin` folder.
. Enter:
----
./tls-toolkit.sh standalone -n 'nifi[<1-n>].<org name>.com' -C 'CN=<name of NiFi client certificate>, O=<org>' -c 'CA.<org>.com' -O -o /<path to secure folder for the certificates>
----
For a description of flag options, click link:http://nifi.apache.org/docs/nifi-docs/html/toolkit-guide.html#usage-8[here].


.Example:
----
./tls-toolkit.sh standalone -n 'nifi[1-3].xyz.com' -C 'CN=nifi-admin-client-cert, O=XYZ LLC' -c 'CA.xyz.com' -O -o ~/NiFi/Certificates/security_certificates_cluster
----
The following image shows the structure for the new security_certificates_cluster directory:
+
image::tls-certificate-folder.png["Security Certificate Directories"]

[start=3]
. Create a new `nifi` folder in an appropriate location. In this example, we created the `nifi` folder in the `root` directory.
.. Enter: `sudo mkdir /nifi`
.. Enter your password.
. Copy the NiFi installation folder (i.e. `nifi-1.11.1`) to a new folder for *each* node in the `nifi` folder that you created in the previous step.
.. Enter: `sudo cp -R <path to installation folder> <path to the new nifi folder>``

.Example:
----
sudo cp -R /Users/spius/Documents/NiFi/nifi-1.11.1 /nifi/cluster/nifi1.xyz.com
sudo cp -R /Users/spius/Documents/NiFi/nifi-1.11.1 /nifi/cluster/nifi2.xyz.com
sudo cp -R /Users/spius/Documents/NiFi/nifi-1.11.1 /nifi/cluster/nifi3.xyz.com
----
[start=5]
. Copy the security certificates to the `conf` folder of *each* node.
.. Navigate to the `NiFi/Certificates/security_certificates_cluster/nifi<n>.xyz.com` folder.
.. Enter: `sudo cp -R * /nifi/cluster/nifi<n>.xyz.com/conf`

=== Step 2. Update the nifi.properties File
. Change the https port number in *each* node’s `nifi.properties` file.
.. Navigate to the `conf` file in the first node: `cd /nifi/cluster/nifi<n>.xyz.com/conf`
.. Enter: `sudo vim nifi.properties`
.. Enter your password.
.. Inside the file, type `/port` and locate the line: `nifi.web.https.port=`
.. Type `i` to edit the file.
.. Change the existing port number to `9441`.
.. Press `ESC:wq` to save and quit.
. Repeat the previous step for the other nodes and change the port number incrementally. For example, use 9442 for the 2nd node and 9443 for the 3rd node.
. Start NiFi in *each* node.
.. Navigate to the `bin` file in the first node: `cd /nifi/cluster/nifi<n>.xyz.com/bin`
.. Enter: `sudo ./nifi.sh start`
.. To check status, enter: `sudo ./nifi.sh status`
.. Repeat this step for the other nodes.
. Update the first node’s `nifi-properties` file.
.. Navigate to the `conf` file for the first node: `cd /nifi/cluster/nifi1.xyz.com/conf`
.. Enter: `sudo vim nifi.properties`
.. Enter your password.
.. Scroll to the #STATE MANAGEMENT# section.
.. Type `i` to edit the file.
.. Locate the following line and change the value to `true`:
----
# Specifies whether or not this instance of NiFi should run an embedded ZooKeeper server
nifi.state.management.embedded.zookeeper.start=true
----
[start=g]
.. Locate the following line and change the value to `true`:
----
# cluster node properties (only configure for cluster nodes) #
nifi.cluster.is.node=true
----
[start=h]
.. Locate the following line and set the value to `nifi1.xyz.com:2181`
----
# zookeeper properties, used for cluster management #
nifi.zookeeper.connect.string=nifi1.xyz.com:2181
----
[start=i]
.. Press `ESC:wq` to save and quit.

. Update the `nifi-properties` file for the other nodes making sure that the following line is set to node 1.
----
nifi.zookeeper.connect.string=nifi1.xyz.com:2181
----

=== Step 3. Update the zookeeper.properties File
Update the `zookeeper.properties` file of the first node.

. Navigate to the first node’s `conf` directory: `cd /nifi/cluster/nifi1.xyz.com/conf`
. Open the `zookeeper.properties` file: `sudo vim zookeeper.properties`
. Search for the following line: `server.1`
. Type `i` to edit.
. Set the value to `nifi1.xyz.com:2888:3888;2181`

.Example
----
server.1=nifi1.xyz.com:2888:3888;2181
----
[start=6]
. Press `ESC:wq` to save and quit.

=== Step 4. Create the myid File
Create the `myid` file for the first node.

. Navigate to the first node’s `conf` directory: `cd /nifi/cluster/nifi1.xyz.com/conf`
. Run the following commands to create the directory:
----
sudo mkdir state
sudo mkdir state/zookeeper
----
[start=3]
. Navigate to the zookeeper directory: `cd state/zookeeper`
. To create the file, enter: `sudo touch myid`
. Enter the password.
. Edit the file. Enter: `sudo vim myid`
* The blank file opens.
. Type `i` to edit.
. Type `1`.
. Press `ESC:wq` to save and quit.

=== Step 5. Update the state-management.xml File
Update the `state-management.xml` file for *each* node.

. From a text editor, open the `state-management.xml` file for the first node from `nifi/cluster/nifi1.xyz.com/conf`
. Locate the ``<cluster-provider>`` section.
. Locate the line ``<property name="Connect String"></property>``
. Add the Zookeeper host name and client port `nifi1.example.com:2181` to the property.
----
<property name="Connect String">nifi1.xyz.com:2181</property>
----
[start=5]
. Save and close the file.
. Repeat the update for the `state-management.xml` file in the other nodes.

=== Step 6. Update the authorizers.xml File
Update the `authorizers.xml` for *each* node.

. From a text editor, open the `authorizers.xml` file for the first node from `nifi/cluster/nifi1.xyz.com/conf`
. Locate the ``<userGroupProvider>`` section.
. Locate the line ``<property name="Initial User Identity 1">CN=nifi-admin-client-cert, O=Example LLC</property>``
. Add the following new lines to specify the Initial User Identity for *each* node:
----
<property name="Initial User Identity 2">CN=nifi1.xyz.com, OU=NIFI</property>
<property name="Initial User Identity 3">CN=nifi2.xyz.com, OU=NIFI</property>
<property name="Initial User Identity 4">CN=nifi3.xyz.com, OU=NIFI</property>
----
+
image::tls-authorizers-file-userGroupProvider.png[userGroupProvider section in the authorizers file]
[start=5]
. Locate the ``<accessPolicyProvider>`` section.
. Locate the line ``<property name="Node Identity 1"></property>``
. Add the CN and OU to the property: ``<property name="Node Identity 1">CN=nifi1.xyz.com, OU=NIFI</property>``
. Add the following lines to specify the node identity for the remaining nodes:
----
<property name="Node Identity 2">CN=nifi2.xyz.com, OU=NIFI</property>
<property name="Node Identity 3">CN=nifi3.xyz.com, OU=NIFI</property>
----
+
image::tls-authorizers-file-accessPolicyProvider.png[accessPolicyProvider section in the authorizers file]

=== Step 7. Delete the authorizations.xml and users.xml Files
Delete the `authorizations.xml` and `users.xml` files from *each* node.

. Navigate to the first node: `nifi/cluster/nifi1.xyz.com/conf`
. Enter: `sudo rm authorizations.xml`
. Enter: `sudo rm users.xml`
. Navigate to *each* of the other nodes and delete the same files.
NOTE: You must delete the `authorizations.xml` and `users.xml` files after you update the `authorizers.xml` file.

=== Step 8. Restart the NiFi Cluster
Restart the NiFi cluster on all nodes simultaneously.

. From the `nifi/cluster` prompt, enter:
----
sudo nifi1.xyz.com/bin/nifi.sh restart; sudo nifi2.xyz.com/bin/nifi.sh restart; sudo nifi3.xyz.com/bin/nifi.sh restart
----
